name: Cleanup GitHub Pages

on:
  schedule:
    # Run monthly on the 1st at 2 AM UTC to clean up old release notes
    - cron: '0 2 1 * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write

jobs:
  cleanup-old-release-notes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup Old Release Notes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Cleaning up old release notes from GitHub Pages (/docs on main)..."
        
        # Clone the main branch (GitHub Pages source is main:/docs)
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git pages-repo
        cd pages-repo
        
        echo "Files before cleanup:"
        ls -la docs/Microverse-v*.html 2>/dev/null || echo "No HTML files found"
        
        # Keep only the last 5 release notes HTML files (keep docs/appcast.xml always)
        if ls docs/Microverse-v*.html 1> /dev/null 2>&1; then
          ls -1 docs/Microverse-v*.html | sed 's#^docs/##' | sort -V | head -n -5 | while read -r f; do rm -f "docs/$f"; done || true
          
          echo "Files after cleanup:"
          ls -la docs/Microverse-v*.html 2>/dev/null || echo "No HTML files remaining"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No old files to clean up"
          else
            git commit -m "chore: cleanup old release notes (keep latest 5 versions)"
            git push origin main
            echo "âœ… Old release notes cleaned up"
          fi
        else
          echo "No release notes files found to clean up"
        fi
